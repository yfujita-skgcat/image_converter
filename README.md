This is an imaging converter plugin for ImageJ derived from a minimal Maven project.


ImageJ でモノクロtif画像を複数の画像で共通のコントラスト調整を行い疑似カラーをつけjpg等に変換するためのpluginです。
変換対象の画像は正規表現で選択し、\<WELL\>, \<POS\>, \<ZPOS\>, \<TIME\>, \<FILTER\> などの名前付きグループで分類して選択できるようになっています。
単純な変換だけでなく、マージやratio画像も作製できるようになっています。ratio画像については定量データも自動的に作製します。

# 使い方

## インストール
名前付き正規表現を使用しているためJavaの最新版をインストールしてください。
また、ImageJのAPIを使用しているのでImageJも最新版が望ましいです。

plugin フォルダに Img_Conv-*.jar コピーしてください。ImageJ のpluginに表示されるようになります。

## 1ページ目

- Convert recursively: フォルダを辿って画像を探します。チェックされていないときは選択したフォルダの階層のみ検索します。
- Remove special characters: シェル等で特殊文字となるような文字列を除去します。
- Add parameter: 変換時のパラメーターをファイル名に付加します。長くなるため推奨しません。
- Ignore symlink: シンボリックリンクのファイルを除外します。
- read MeasurememtProtocol.xml: CQ1の撮影条件ファイルを読み込んでウェル番号やフィルタ名を正しく(A1, A2, PhaseContrast 等)に変換してくれます。

- Choose Source Folder: 変換元のtif画像が入っているフォルダを選択してください。フォーマットはモノクロtif画像です。
- Choose Save Folder: 変換先のフォルダを指定してください。このフォルダにログ等も出力されます。

- File Format: 変換後のファイルフォーマットを指定してください。すべてカラーとなります。
- Max display range: 画像が可能な最大輝度値を指定してください。
- Resize (pixel): 画像をリサイズする場合の横幅をピクセル数で指定してください。
- Exclude: 除外したいファイル名を正規表現で指定してください。フルパスに対してマッチを行います。

## 変換ファイルの指定の仕方(正規表現)

変換ファイルの指定はJavaの正規表現で行います。例えば、
A05-position1-zstack2-time5-GFP.tif
などのファイル名の場合、Custom を選んで適当な名前に変更した後、名前付きグループを使い、(?\<WELL\>[A-Z]\d+)-position(?\<POS\>\d+)-zstack(?\<ZPOS\>\d+)-time(?\<TIME\>\d+)-(?\<FILTER\>.*)\.tif
と指定すると、次のページでウェルやポジションで分類して表示してくれます。この時指定した名前で正規表現を再度呼び出すことも出来ます。

ファイル名と正規表現の例:
```
- 293 10_wNIBA.tif: (?<WELL>.*)[ -](?<POS>\d+)_w(?<FILTER>[^.]+)\.(?:TIF|tif|TIFF|tiff)
- HeLa_wNIBA.tif: (?<WELL>.*)_w(?<FILTER>[^.]+)\.(?:TIF|tif|TIFF|tiff)
- 13_wNIBA.tif: (?<WELL>\d+)_w(?<FILTER>[^.]+)\.(?:TIF|tif|TIFF|tiff)
- B01-01.tif: (?<WELL>[A-Z]\d+)-(?<POS>\d+)_w(?<FILTER>[^.]+)\.(?:TIF|tif|TIFF|tiff)
- B01-01.tif でB行だけを返還する場合: (?<WELL>B\d+)-(?<POS>\d+)_w(?<FILTER>[^.]+)\.(?:TIF|tif|TIFF|tiff)
```
正規表現を入力したらnext ボタンをクリックしてください。ファイルの検索が行われ、ファイルが見つかれば次のページへ進みます。

## 2ページ目

左上の select color で選択を行ってください。

- 変換モードを指定してください。
  - Single: 単純変換です。
  - Merge: 複数のチャンネルをマージして変換します。
  - Threashold: Relative で比をとる領域を決めるためにthresholdを設定します。これは細胞がいない領域では比をとると異常値を示すため、画像と計算結果から除外するためです。
  - Relative: ratioイメージを精製します。
- 色を指定してください。選択中のフィルタの色を変更することが出来ます。
- フィルタを選択してください。これは正規表現で\<FILTER\>と名前をつけた部分の文字列が入ります。フィルタごとの設定は自動的に保存されます。
  
- 共通項目(ヒストグラム)
  - スライダや数値を直接入力してコントラストを調整してください。Threshold モードでは計算対象の領域を決定するための域値を入力してください。
  - auto にチェックを入れると、**各画像のヒストグラムから各画像別々のコントラストで自動的にコントラストを調整します。そのため、蛍光画像の変換には用いないでください。** 通常、水滴等で暗くなる透過光画像の自動コントラスト調整のための機能です。
  - manual にチェックを入れると手動でコントラスト調整を行います。adjust ボタンは自動コントラスト調整を行う場合のコントラスト位置に設定しますが、各画像ごとに自動で調整は行いません。
  - adjust の右の数値は adjust ボタンを押した時、または auto モードの時、何%上位のピクセルを削るかを指定します。
  - background processing ball size (\>20): バックグラウンド除去補正を行います。ImageJ のsubtract background と同じ機能です。0 で無効で20 以上を指定しないと機能しません。
  
- 共通項目(画像部分)
  - 下のプルダウンメニューからウェルやポジションを選択してください。ここの選択肢は正規表現の\<WELL\>, \<POS\>, \<ZPOS\>, \<TIME\> で指定されていた部分が現れます。
  - 画像をドラッグすると、切り抜きする範囲を指定できます。右下の、x, y, w, h で数値で指定することも出来ます。すべてが0の時切り抜きを行いません。
  - %を変更すると表示される画像サイズを変更できます。実際のサイズ変換には影響しません。ctrlを押しながらホイールを回してもサイズを変更できます。

- Merge モードのときの追加設定
  - Merge モードのときはマージするチャンネルが指定できます。必要なチャンネルをチェックしてください。
 
- Relative モードのときの追加設定
  - ヒートマップの種類を選択します。通常はBlue_Green_Red で良いです。
  - ratio イメージを作製する領域を決定するために"Use for finding cell" で使用するチャンネルを選択してください。このときの領域はThresholdモードで指定した領域が使用されます。複数のチャンネルを指定すると、複数のチャンネルで共通の領域を選択します。それ以外の領域は0としてratioイメージの作製範囲、計算範囲から除外されます。
  - 割られるチャンネルをT (target)で選択肢、割るチャンネルをR (reference)から選択してください。
 
設定が終わったら、next ボタンをクリックしてください。

## 3ページ目(確認)
変換の設定が表示されます。
問題なければconvertボタンをクリックしてください。変換が行われます。
